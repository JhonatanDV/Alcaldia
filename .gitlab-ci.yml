stages:
  - test
  - build
  - deploy

test_backend:
  image: python:3.11
  services:
    - name: postgres:15
      alias: postgres
    - name: minio/minio:latest
      alias: minio
      command: ["server", "/data"]
  variables:
    POSTGRES_DB: $POSTGRES_DB
    POSTGRES_USER: $POSTGRES_USER
    POSTGRES_PASSWORD: $POSTGRES_PASSWORD
    DATABASE_URL: $DATABASE_URL
    MINIO_ACCESS_KEY: $MINIO_ACCESS_KEY
    MINIO_SECRET_KEY: $MINIO_SECRET_KEY
    MINIO_ENDPOINT: $MINIO_ENDPOINT
  before_script:
    - pip install -r requirements.txt
    - export DJANGO_SETTINGS_MODULE=core.settings
    - python manage.py migrate
  script:
    - pytest -q
  only:
    - merge_requests
    - develop

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -f Dockerfile.test .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  only:
    - main

deploy_staging:
  stage: deploy
  script:
    - echo "Deploy to staging"
    # Add deployment commands here
  only:
    - develop

deploy_production:
  stage: deploy
  script:
    - echo "Deploy to production"
    # Add deployment commands here
  only:
    - main
